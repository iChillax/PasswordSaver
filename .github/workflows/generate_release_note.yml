name: Production - Build & Deploy AI Search Container app
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Tag version to deploy (e.g., v1.0.0)'
        required: true
  
permissions:
  contents: read
  id-token: write

jobs:
  # ============================================
  # STAGE 0: VERSION CHECK
  # ============================================
  version-check:
    runs-on: ubuntu-lastest
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog_entry: ${{ steps.changelog.outputs.entry }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag or input
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Extract or generate changelog entry
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}
          
          # Try to extract from CHANGELOG.md first
          if [ -f "CHANGELOG.md" ]; then
            CHANGELOG=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | head -n -1)
            
            if [ -n "$CHANGELOG" ]; then
              echo "✓ Changelog entry found in CHANGELOG.md for version $VERSION"
              echo "entry<<EOF" >> $GITHUB_OUTPUT
              echo "$CHANGELOG" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          # If no manual changelog, auto-generate from git commits
          echo "⚠️  No changelog entry found. Auto-generating from git commits..."
          
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git rev-list --max-parents=0 HEAD)
          
          echo "Generating changelog from $PREV_TAG to HEAD"
          
          # Initialize changelog sections
          ADDED=""
          CHANGED=""
          FIXED=""
          SECURITY=""
          BREAKING=""
          OTHER=""
          
          # Parse commits since last tag
          while IFS= read -r commit; do
            # Extract commit message
            MSG=$(echo "$commit" | sed 's/^[a-f0-9]* //')
            
            # Categorize based on conventional commit format
            if [[ "$MSG" =~ ^feat(\(.*\))?!: ]]; then
              BREAKING="${BREAKING}- ${MSG#*: }\n"
            elif [[ "$MSG" =~ ^feat(\(.*\))?: ]]; then
              ADDED="${ADDED}- ${MSG#*: }\n"
            elif [[ "$MSG" =~ ^fix(\(.*\))?: ]]; then
              FIXED="${FIXED}- ${MSG#*: }\n"
            elif [[ "$MSG" =~ ^security(\(.*\))?: ]]; then
              SECURITY="${SECURITY}- ${MSG#*: }\n"
            elif [[ "$MSG" =~ ^(chore|docs|style|refactor|perf|test|build|ci)(\(.*\))?: ]]; then
              CHANGED="${CHANGED}- ${MSG#*: }\n"
            else
              OTHER="${OTHER}- ${MSG}\n"
            fi
          done < <(git log --oneline $PREV_TAG..HEAD)
          
          # Build changelog
          CHANGELOG="## [$VERSION] - $(date +%Y-%m-%d)\n\n"
          
          if [ -n "$BREAKING" ]; then
            CHANGELOG="${CHANGELOG}### ⚠️ BREAKING CHANGES\n${BREAKING}\n"
          fi
          
          if [ -n "$ADDED" ]; then
            CHANGELOG="${CHANGELOG}### Added\n${ADDED}\n"
          fi
          
          if [ -n "$CHANGED" ]; then
            CHANGELOG="${CHANGELOG}### Changed\n${CHANGED}\n"
          fi
          
          if [ -n "$FIXED" ]; then
            CHANGELOG="${CHANGELOG}### Fixed\n${FIXED}\n"
          fi
          
          if [ -n "$SECURITY" ]; then
            CHANGELOG="${CHANGELOG}### Security\n${SECURITY}\n"
          fi
          
          if [ -n "$OTHER" ]; then
            CHANGELOG="${CHANGELOG}### Other\n${OTHER}\n"
          fi
          
          # If no categorized commits, add a generic entry
          if [ -z "$ADDED" ] && [ -z "$CHANGED" ] && [ -z "$FIXED" ] && [ -z "$SECURITY" ] && [ -z "$OTHER" ] && [ -z "$BREAKING" ]; then
            CHANGELOG="${CHANGELOG}### Changed\n- Automated deployment\n"
          fi
          
          echo "✓ Auto-generated changelog from git commits"
          
          echo "entry<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
  # ============================================
  # STAGE 0: GENERATE IMAGE TAG
  # ============================================
  generate-tag:
    runs-on: ubuntu-lastest
    outputs:
      tag: ${{ steps.vars.outputs.TAG }}
    steps:
      - name: Generate unique image tag
        id: vars
        run: |
          VERSION=${{ needs.version-check.outputs.version }}
          echo TAG="${VERSION}-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}"  >> $GITHUB_OUTPUT
  # ============================================
  # STAGE 1: UNIT TESTS
  # ============================================
  unit-tests:
    runs-on: ubuntu-lastest
    needs: version-check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Run unit tests
        run: echo "Passed"

  # ============================================
  # STAGE 2: INTEGRATION TESTS
  # ============================================
  integration-tests:
    runs-on: ubuntu-lastest
    needs: unit-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Run integration tests
        run: echo "Passed"

  # ============================================
  # STAGE 3: BUILD & SECURITY SCAN
  # ============================================
  build-and-scan:
    runs-on: ubuntu-lastest
    needs: [unit-tests, integration-tests, version-check, generate-tag]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          IMAGE=${{ secrets.ACR_NAME }}.azurecr.io/housing_api_search:${{ needs.generate-tag.outputs.tag }}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

     

  # ============================================
  # STAGE 4: DEPLOY TO PRODUCTION
  # ============================================
  deploy:
    runs-on: ubuntu-lastest
    needs: [build-and-scan, version-check, generate-tag]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Container App
        run: |
          TAG=${{ needs.generate-tag.outputs.tag }}
          IMAGE=${{ secrets.ACR_NAME }}.azurecr.io/housing_api_search:$TAG
          
          echo "Deploying version: $VERSION"
          echo "Image: $IMAGE"

      - name: Create deployment annotation
        run: |
          VERSION=${{ needs.version-check.outputs.version }}
          COMMIT_SHA=${{ github.sha }}
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          echo "✓ Deployment successful"
          echo "Version: $VERSION"
          echo "Commit: $COMMIT_SHA"
          echo "Message: $COMMIT_MSG"

  # ============================================
  # STAGE 5: CREATE RELEASE & TAG
  # ============================================
  create-release:
    runs-on: ubuntu-latest
    needs: [deploy, version-check, generate-tag]
    if: success()
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Git tag
        run: |
          VERSION=${{ needs.version-check.outputs.version }}
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "v$VERSION" -m "Release version $VERSION" || echo "Tag already exists"
          git push origin "v$VERSION" || echo "Tag push skipped"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.version-check.outputs.version }}
          release_name: Release ${{ needs.version-check.outputs.version }}
          body: ${{ needs.version-check.outputs.changelog_entry }}
          draft: false
          prerelease: false
